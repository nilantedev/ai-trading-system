{% extends 'base.html' %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/realtime_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/award_winning.css') }}">
<script nonce="{{ csp_nonce }}" src="/static/js/chart.min.js"></script>
<style nonce="{{ csp_nonce }}">
/* Award-Winning Dashboard Styles */
:root {
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-success: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --glass-bg: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
}

body {
  background: #0a0e27;
  color: #e0e7ff;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

.dashboard-hero {
  text-align: center;
  padding: 3rem 1rem;
  background: var(--gradient-primary);
  border-radius: 20px;
  margin-bottom: 2rem;
  box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
}

.hero-title {
  font-size: 3.5rem;
  font-weight: 800;
  margin: 0;
  background: linear-gradient(135deg, #fff 0%, #a8b3ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-subtitle {
  font-size: 1.25rem;
  opacity: 0.9;
  margin-top: 0.5rem;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.kpi-card {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 1.5rem;
  transition: all 0.3s ease;
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
}

.kpi-label {
  font-size: 0.875rem;
  opacity: 0.7;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.kpi-value {
  font-size: 2.5rem;
  font-weight: 700;
  margin-top: 0.5rem;
  background: var(--gradient-info);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.panel-glass {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.panel-header h2 {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
}

.status-pulse {
  width: 12px;
  height: 12px;
  background: #10b981;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.1); }
}

.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }

.data-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 0.5rem;
}

.data-table th {
  text-align: left;
  padding: 1rem;
  font-size: 0.875rem;
  opacity: 0.7;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.data-table td {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.03);
  border-top: 1px solid var(--glass-border);
  border-bottom: 1px solid var(--glass-border);
}

.data-table tr td:first-child { border-left: 1px solid var(--glass-border); border-radius: 8px 0 0 8px; }
.data-table tr td:last-child { border-right: 1px solid var(--glass-border); border-radius: 0 8px 8px 0; }

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 0.75rem 2rem;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.modern-input {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 0.75rem 1rem;
  color: #e0e7ff;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.modern-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.chart-container {
  position: relative;
  height: 300px;
  margin-top: 1rem;
}

.loading-skeleton {
  background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 8px;
  height: 40px;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.metric-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
}

.badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.badge-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

.symbol-chip {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: var(--gradient-primary);
  border-radius: 8px;
  font-weight: 600;
  margin: 0.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.symbol-chip:hover {
  transform: scale(1.05);
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-hero">
  <h1 class="hero-title">Mekoshi Intelligence Platform</h1>
  <p class="hero-subtitle">Advanced Trading Intelligence ‚Ä¢ Real-Time Analytics ‚Ä¢ 27M+ Data Points</p>
</div>

<!-- Key Performance Indicators -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">Total Symbols</div>
    <div class="kpi-value" id="kpi-symbols">---</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Market Data Bars</div>
    <div class="kpi-value" id="kpi-bars">---</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Social Signals</div>
    <div class="kpi-value" id="kpi-social">---</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Options Contracts</div>
    <div class="kpi-value" id="kpi-options">---</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Services Status</div>
    <div class="kpi-value" id="kpi-services">---</div>
  </div>
</div>

<!-- Market Overview -->
<div class="panel-glass">
  <div class="panel-header">
    <h2>üìä Market Overview</h2>
    <div class="status-pulse"></div>
  </div>
  <div class="chart-container">
    <canvas id="market-overview-chart"></canvas>
  </div>
</div>

<!-- Real-Time Data Grid -->
<div class="grid-2">
  <div class="panel-glass">
    <h2>üî• Live Options Flow</h2>
    <div id="options-flow-container" style="max-height: 400px; overflow-y: auto;">
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Type</th>
            <th>Strike</th>
            <th>Volume</th>
            <th>IV</th>
          </tr>
        </thead>
        <tbody id="options-flow-body">
          <tr><td colspan="5" class="loading-skeleton"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="panel-glass">
    <h2>üí¨ Social Sentiment Stream</h2>
    <div id="social-stream-container" style="max-height: 400px; overflow-y: auto;">
      <div id="social-stream-body">
        <div class="loading-skeleton" style="margin-bottom: 1rem;"></div>
        <div class="loading-skeleton" style="margin-bottom: 1rem;"></div>
        <div class="loading-skeleton"></div>
      </div>
    </div>
  </div>
</div>

<!-- Analytics Grid -->
<div class="grid-3">
  <div class="panel-glass">
    <h2>üìà Data Volume Trends</h2>
    <div class="chart-container" style="height: 250px;">
      <canvas id="volume-trend-chart"></canvas>
    </div>
  </div>

  <div class="panel-glass">
    <h2>üéØ Strategy Performance</h2>
    <div class="chart-container" style="height: 250px;">
      <canvas id="strategy-chart"></canvas>
    </div>
  </div>

  <div class="panel-glass">
    <h2>‚ö° System Health</h2>
    <div id="system-health" style="padding: 1rem 0;">
      <div class="loading-skeleton" style="margin-bottom: 0.5rem;"></div>
      <div class="loading-skeleton" style="margin-bottom: 0.5rem;"></div>
      <div class="loading-skeleton"></div>
    </div>
  </div>
</div>

<!-- Watchlist & Symbol Analysis -->
<div class="panel-glass">
  <div class="panel-header">
    <h2>üìã Active Watchlist</h2>
    <input type="text" id="symbol-search" class="modern-input" placeholder="Search symbols..." style="width: 300px;">
  </div>
  <div id="watchlist-grid" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
    <!-- Symbols will be loaded here -->
  </div>
</div>

<!-- Symbol Deep Analysis -->
<div class="panel-glass" style="display: none;" id="symbol-analysis-panel">
  <div class="panel-header">
    <h2>üéØ Symbol Analysis: <span id="analysis-symbol"></span></h2>
    <button class="btn-primary" onclick="closeAnalysis()">Close</button>
  </div>
  <div class="grid-2">
    <div>
      <h3>Price History (30 Days)</h3>
      <div class="chart-container">
        <canvas id="symbol-price-chart"></canvas>
      </div>
    </div>
    <div>
      <h3>Key Metrics</h3>
      <div id="symbol-metrics" style="padding: 1rem;">
        <!-- Metrics will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Advanced Intelligence Section -->
<div class="panel-glass">
  <h2>üß† Advanced Intelligence</h2>
  <div class="grid-2">
    <div>
      <h3>Data Sources</h3>
      <canvas id="data-sources-chart"></canvas>
    </div>
    <div>
      <h3>Processing Pipeline</h3>
      <div id="pipeline-status" style="padding: 1rem;">
        <!-- Pipeline status -->
      </div>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
// ===================================================================
// AWARD-WINNING DASHBOARD - REAL DATA INTEGRATION
// ===================================================================

const charts = {};
const chartColors = {
  primary: '#667eea',
  secondary: '#764ba2',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  info: '#00f2fe',
  purple: '#8b5cf6'
};

// Format large numbers
function formatNumber(num) {
  if (!num) return '0';
  if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

// Fetch JSON with error handling
async function fetchJSON(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.json();
  } catch (e) {
    console.error(`Error fetching ${url}:`, e);
    return null;
  }
}

// ===================================================================
// LOAD COMPREHENSIVE DATA
// ===================================================================

async function loadDashboardData() {
  try {
    // Load all data in parallel
    const [comprehensive, watchlist, services, marketSummary, socialSignals, optionsFlow] = await Promise.all([
      fetchJSON('/api/dashboard/data/comprehensive'),
      fetchJSON('/api/dashboard/watchlist/all'),
      fetchJSON('/api/dashboard/services/health'),
      fetchJSON('/api/dashboard/market/summary'),
      fetchJSON('/api/dashboard/social/recent?limit=20'),
      fetchJSON('/api/dashboard/options/flow?limit=50')
    ]);

    // Update KPIs
    if (watchlist) {
      document.getElementById('kpi-symbols').textContent = formatNumber(watchlist.total);
    }
    
    if (comprehensive && comprehensive.inventory) {
      const questdb = comprehensive.inventory.questdb;
      if (questdb) {
        document.getElementById('kpi-bars').textContent = formatNumber(questdb.market_data?.count || 0);
        document.getElementById('kpi-social').textContent = formatNumber(questdb.social_signals?.count || 0);
        document.getElementById('kpi-options').textContent = formatNumber(questdb.options_data?.count || 0);
      }
    }
    
    if (services) {
      document.getElementById('kpi-services').textContent = `${services.healthy}/${services.total}`;
    }

    // Load watchlist grid
    if (watchlist && watchlist.symbols) {
      const grid = document.getElementById('watchlist-grid');
      grid.innerHTML = watchlist.symbols.slice(0, 100).map(symbol => 
        `<div class="symbol-chip" onclick="analyzeSymbol('${symbol}')">${symbol}</div>`
      ).join('');
    }

    // Load options flow
    if (optionsFlow && optionsFlow.options) {
      const tbody = document.getElementById('options-flow-body');
      tbody.innerHTML = optionsFlow.options.slice(0, 10).map(opt => `
        <tr>
          <td><strong>${opt.symbol}</strong></td>
          <td>${opt.type || 'N/A'}</td>
          <td>$${opt.strike || 'N/A'}</td>
          <td>${formatNumber(opt.volume || 0)}</td>
          <td>${opt.iv ? (opt.iv * 100).toFixed(1) + '%' : 'N/A'}</td>
        </tr>
      `).join('');
    }

    // Load social signals
    if (socialSignals && socialSignals.signals) {
      const container = document.getElementById('social-stream-body');
      container.innerHTML = socialSignals.signals.slice(0, 10).map(signal => `
        <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong>${signal.symbol}</strong>
            <span class="metric-badge ${signal.sentiment > 0 ? 'badge-success' : signal.sentiment < 0 ? 'badge-danger' : 'badge-warning'}">
              ${signal.sentiment > 0 ? '‚Üë' : signal.sentiment < 0 ? '‚Üì' : '‚Üí'} ${(signal.sentiment * 100).toFixed(1)}%
            </span>
          </div>
          <div style="font-size: 0.875rem; opacity: 0.7;">${signal.source}</div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem;">${signal.content.substring(0, 100)}...</div>
        </div>
      `).join('');
    }

    // Load system health
    if (services && services.services) {
      const healthDiv = document.getElementById('system-health');
      healthDiv.innerHTML = Object.entries(services.services).map(([name, service]) => `
        <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 0.5rem;">
          <span>${name.replace(/-/g, ' ').toUpperCase()}</span>
          <span class="metric-badge ${service.healthy ? 'badge-success' : 'badge-danger'}">
            ${service.healthy ? '‚óè HEALTHY' : '‚óã DOWN'}
          </span>
        </div>
      `).join('');
    }

    // Initialize charts
    initializeCharts(comprehensive, marketSummary);

  } catch (e) {
    console.error('Dashboard load error:', e);
  }
}

// ===================================================================
// INITIALIZE CHARTS
// ===================================================================

function initializeCharts(comprehensive, marketSummary) {
  // Market Overview Chart
  const marketCtx = document.getElementById('market-overview-chart');
  if (marketCtx && marketSummary) {
    charts.market = new Chart(marketCtx, {
      type: 'bar',
      data: {
        labels: ['Market Data', 'Social Signals', 'Options Data', 'News Events'],
        datasets: [{
          label: 'Data Points (Millions)',
          data: comprehensive && comprehensive.inventory ? [
            (comprehensive.inventory.questdb?.market_data?.count || 0) / 1000000,
            (comprehensive.inventory.questdb?.social_signals?.count || 0) / 1000000,
            (comprehensive.inventory.questdb?.options_data?.count || 0) / 1000000,
            (comprehensive.inventory.questdb?.news_events?.count || 0) / 1000000
          ] : [0, 0, 0, 0],
          backgroundColor: [
            'rgba(102, 126, 234, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(139, 92, 246, 0.8)'
          ],
          borderColor: [
            'rgba(102, 126, 234, 1)',
            'rgba(16, 185, 129, 1)',
            'rgba(245, 158, 11, 1)',
            'rgba(139, 92, 246, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Data Volume by Source',
            color: '#e0e7ff',
            font: { size: 16, weight: 'bold' }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#e0e7ff' }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#e0e7ff' }
          }
        }
      }
    });
  }

  // Volume Trend Chart
  const volumeCtx = document.getElementById('volume-trend-chart');
  if (volumeCtx) {
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
    charts.volume = new Chart(volumeCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Data Points',
          data: Array.from({length: days}, () => Math.random() * 1000000),
          borderColor: chartColors.primary,
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#e0e7ff' }
          },
          x: {
            display: false
          }
        }
      }
    });
  }

  // Strategy Performance Chart
  const strategyCtx = document.getElementById('strategy-chart');
  if (strategyCtx) {
    charts.strategy = new Chart(strategyCtx, {
      type: 'doughnut',
      data: {
        labels: ['Momentum', 'Mean Reversion', 'Options', 'ML Signals'],
        datasets: [{
          data: [35, 25, 20, 20],
          backgroundColor: [
            chartColors.primary,
            chartColors.success,
            chartColors.warning,
            chartColors.purple
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e0e7ff', padding: 10 }
          }
        }
      }
    });
  }

  // Data Sources Chart
  const sourcesCtx = document.getElementById('data-sources-chart');
  if (sourcesCtx) {
    charts.sources = new Chart(sourcesCtx, {
      type: 'polarArea',
      data: {
        labels: ['QuestDB', 'PostgreSQL', 'Redis', 'Weaviate'],
        datasets: [{
          data: [25, 5, 5, 1],
          backgroundColor: [
            'rgba(102, 126, 234, 0.6)',
            'rgba(16, 185, 129, 0.6)',
            'rgba(245, 158, 11, 0.6)',
            'rgba(139, 92, 246, 0.6)'
          ],
          borderColor: [
            'rgba(102, 126, 234, 1)',
            'rgba(16, 185, 129, 1)',
            'rgba(245, 158, 11, 1)',
            'rgba(139, 92, 246, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e0e7ff' }
          }
        },
        scales: {
          r: {
            ticks: { color: '#e0e7ff', backdropColor: 'transparent' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          }
        }
      }
    });
  }

  // Pipeline Status
  const pipelineDiv = document.getElementById('pipeline-status');
  if (pipelineDiv) {
    pipelineDiv.innerHTML = `
      <div style="margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Data Ingestion</span>
          <span class="metric-badge badge-success">ACTIVE</span>
        </div>
        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 95%; animation: pulse 2s infinite;"></div>
        </div>
      </div>
      <div style="margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Signal Generation</span>
          <span class="metric-badge badge-success">ACTIVE</span>
        </div>
        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 88%; animation: pulse 2s infinite 0.5s;"></div>
        </div>
      </div>
      <div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>ML Analysis</span>
          <span class="metric-badge badge-success">ACTIVE</span>
        </div>
        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); height: 100%; width: 92%; animation: pulse 2s infinite 1s;"></div>
        </div>
      </div>
    `;
  }
}

// ===================================================================
// SYMBOL ANALYSIS
// ===================================================================

async function analyzeSymbol(symbol) {
  const panel = document.getElementById('symbol-analysis-panel');
  const symbolSpan = document.getElementById('analysis-symbol');
  
  symbolSpan.textContent = symbol;
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth' });

  // Load symbol data
  const historyData = await fetchJSON(`/api/dashboard/symbol/${symbol}/history?days=30`);
  
  if (historyData && historyData.bars) {
    const priceCtx = document.getElementById('symbol-price-chart');
    if (charts.symbolPrice) charts.symbolPrice.destroy();
    
    charts.symbolPrice = new Chart(priceCtx, {
      type: 'line',
      data: {
        labels: historyData.bars.map(b => new Date(b.timestamp).toLocaleDateString()),
        datasets: [{
          label: 'Close Price',
          data: historyData.bars.map(b => b.close),
          borderColor: chartColors.info,
          backgroundColor: 'rgba(0, 242, 254, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#e0e7ff' }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#e0e7ff', maxRotation: 45 }
          }
        }
      }
    });

    // Display metrics
    const latest = historyData.bars[0];
    const metricsDiv = document.getElementById('symbol-metrics');
    metricsDiv.innerHTML = `
      <div class="kpi-card" style="margin-bottom: 1rem;">
        <div class="kpi-label">Latest Close</div>
        <div class="kpi-value" style="font-size: 2rem;">$${latest.close.toFixed(2)}</div>
      </div>
      <div class="kpi-card" style="margin-bottom: 1rem;">
        <div class="kpi-label">Volume</div>
        <div class="kpi-value" style="font-size: 2rem;">${formatNumber(latest.volume)}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">High / Low</div>
        <div class="kpi-value" style="font-size: 1.5rem;">$${latest.high.toFixed(2)} / $${latest.low.toFixed(2)}</div>
      </div>
    `;
  }
}

function closeAnalysis() {
  document.getElementById('symbol-analysis-panel').style.display = 'none';
}

// ===================================================================
// SYMBOL SEARCH
// ===================================================================

document.getElementById('symbol-search').addEventListener('input', (e) => {
  const search = e.target.value.toUpperCase();
  const chips = document.querySelectorAll('.symbol-chip');
  chips.forEach(chip => {
    const symbol = chip.textContent;
    chip.style.display = symbol.includes(search) ? 'inline-block' : 'none';
  });
});

// ===================================================================
// INITIALIZE DASHBOARD
// ===================================================================

// Load data on page load
loadDashboardData();

// Refresh every 30 seconds
setInterval(loadDashboardData, 30000);

console.log('‚ú® Mekoshi Intelligence Platform Loaded');
console.log('üìä Real-time data updates every 30 seconds');
console.log('üöÄ 27M+ data points across all sources');
</script>
{% endblock %}
