{% extends 'base.html' %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/realtime_dashboard.css') }}">
{% endblock %}
{% block content %}
<h1>Business Intelligence Dashboard <span class="health-indicator healthy" data-health-component="live-data"></span></h1>

<section id="primary-kpis" class="panel">
  <h2>Platform KPIs (Live)</h2>
  <div class="metric-grid" id="kpi-grid">
    <div class="metric-card"><h3>Active Strategies</h3><div class="metric-value" data-kpi="active_strategies">â€”</div><div class="metric-sub">Deployed</div></div>
    <div class="metric-card"><h3>Daily Signals</h3><div class="metric-value" data-kpi="daily_signals">â€”</div><div class="metric-sub">Generated</div></div>
    <div class="metric-card"><h3>Signal Latency</h3><div class="metric-value" data-kpi="avg_signal_latency_ms">â€”</div><div class="metric-sub">ms avg</div></div>
    <div class="metric-card"><h3>Risk Alerts</h3><div class="metric-value" data-kpi="risk_alerts_today">â€”</div><div class="metric-sub">Today</div></div>
    <div class="metric-card"><h3>Pending Deploys</h3><div class="metric-value" data-kpi="deployments_pending">â€”</div><div class="metric-sub">Awaiting approval</div></div>
    <div class="metric-card"><h3>Live Streams</h3><div class="metric-value" data-kpi="active_streams">â€”</div><div class="metric-sub">Connected</div></div>
  </div>
</section>

<section class="panel">
  <h2>ðŸ”¥ Live Options Flow (Whale Tracker)</h2>
  <div id="options-flow" style="max-height: 400px; overflow-y: auto;">
    <p style="text-align:center; padding:20px; color:#9e9e9e;">Connecting to real-time options feed...</p>
  </div>
</section>

<section class="grid two">
  <div class="card">
    <h2>Market Heatmap (Real-Time)</h2>
    <div id="market-heatmap">Loading sector performance...</div>
  </div>
  <div class="card" style="grid-column: 1 / -1;">
    <h2>ðŸŽ¯ PhD-Level Symbol Intelligence</h2>
    <div class="controls" style="margin-bottom: 16px;">
      <label for="intel-symbol">Analyze Symbol:</label>
      <input id="intel-symbol" type="text" value="AAPL" placeholder="AAPL, TSLA, SPY..." style="text-transform: uppercase;" />
      <button id="intel-run" class="button primary">Run Full Analysis</button>
    </div>
    <div id="intelligence-panel" style="min-height: 300px;">
      <p style="text-align:center; padding:40px; color:#9e9e9e;">Enter a symbol above and click "Run Full Analysis" for comprehensive PhD-level insights including ML forecast, factor exposures, risk metrics, options signals, news sentiment, and trading recommendations.</p>
    </div>
  </div>
</section>
<section class="grid four" id="analytics-kpis">
  <div class="card" id="coverage-panel">
    <h2>Coverage</h2>
    <div id="coverage-body">Loadingâ€¦</div>
    <div class="panel-sub mini" id="backfill-status" style="margin-top:0.4rem;font-size:0.65rem;">Backfill: <span class="badge" id="backfill-complete">?</span></div>
  </div>
  <div class="card" id="ingestion-panel">
    <h2>Ingestion Freshness</h2>
    <div id="ingestion-body">Loadingâ€¦</div>
    <div class="panel-sub mini" style="margin-top:0.4rem;font-size:0.65rem;">Lag Classes: <span id="lag-classes">â€”</span></div>
  </div>
  <div class="card" id="risk-panel">
    <h2>Risk Posture</h2>
    <ul class="tight">
      <li>VaR (95%) <span data-field="var_95">â€”</span></li>
      <li>Expected Shortfall (95%) <span data-field="es_95">â€”</span></li>
      <li>Exposure Concentration <span data-field="exposure_conc">â€”</span></li>
      <li>Max Drawdown (30d) <span data-field="mdd_30d">â€”</span></li>
      <li>Open Risk Alerts <span data-field="open_risk_alerts">â€”</span></li>
    </ul>
  </div>
  <div class="card" id="alpha-analytics">
    <h2>Alpha & Factors</h2>
    <ul class="tight">
      <li>Alpha Attribution <span data-field="alpha_attr">â€”</span></li>
      <li>Realized Vol (5d) <span data-field="real_vol">â€”</span></li>
      <li>Implied Vol Skew <span data-field="iv_skew">â€”</span></li>
      <li>Signal Drift Score <span data-field="drift_score">â€”</span></li>
      <li>Beta (vs SPX) <span data-field="beta">â€”</span></li>
      <li>Cross-Correlation (Top) <span data-field="xcorr">â€”</span></li>
    </ul>
  </div>
</section>

<section class="grid three">
  <div class="card" id="strategy-perf">
    <h2>Strategy Performance</h2>
    <div class="mini-metrics" id="strategy-metrics">Loadingâ€¦</div>
    <div class="panel-sub" style="margin-top:0.5rem;font-size:0.7rem;">Metrics refreshed intraday from performance store.</div>
  </div>
  <div class="card" id="model-governance">
    <h2>Model Governance</h2>
    <ul class="tight" id="model-gov">
      <li>Production Models <span data-field="prod_models">â€”</span></li>
      <li>Shadow Models <span data-field="shadow_models">â€”</span></li>
      <li>Pending Promotions <span data-field="pending_promotions">â€”</span></li>
      <li>Last Drift Check <span data-field="last_drift">â€”</span></li>
      <li>Avg Drift Magnitude <span data-field="drift_mag">â€”</span></li>
    </ul>
  </div>
    <div class="card" id="news-flow">
      <h2>News & Sentiment</h2>
      <div id="news-flow-body">Loadingâ€¦</div>
    </div>
</section>

<section class="panel">
  <h2>Positions & Greeks</h2>
  <table id="positions"><thead><tr><th>Symbol</th><th>Qty</th><th>Avg</th><th>Last</th><th>P/L</th></tr></thead><tbody></tbody></table>
  <div class="note" style="margin-top:0.5rem;font-size:0.7rem;">Greeks (Î” Î“ Î˜ Vega) aggregation pending real-time inference hook; placeholder values suppressed to avoid misleading display.</div>
</section>

<section class="grid two">
  <div class="panel">
  <h2>Forecast</h2>
    <div id="forecast-body">Loadingâ€¦</div>
  <div class="panel-sub" style="font-size:0.65rem;">1D expected return & confidence (post feature vector inference). <span id="forecast-fallback" class="badge" style="display:none">fallback</span></div>
  </div>
  <div class="panel">
    <h2>News Sentiment</h2>
    <div id="news-sentiment-body">Loadingâ€¦</div>
    <canvas id="sentimentChart" class="chart" height="160" aria-label="News sentiment history" role="img" style="margin-top:10px;width:100%;"></canvas>
  </div>
</section>

<section class="panel">
  <h2>Company Analytics</h2>
  <div class="controls">
    <label for="company-select">Company</label>
    <select id="company-select" aria-label="Select company"></select>
    <a id="company-link" class="button ghost" href="#" rel="nofollow">Open Profile</a>
  </div>
  <div class="grid three" style="margin-top:0.75rem;">
    <div class="card mini"><h3>Fundamentals</h3><div id="fundamentals-box" class="mini-metrics">â€”</div></div>
    <div class="card mini"><h3>Factor Exposures</h3><div id="factors-box" class="mini-metrics">â€”</div></div>
    <div class="card mini"><h3>Risk & Options</h3><div id="risk-options-box" class="mini-metrics">â€”</div></div>
  </div>
  <canvas id="sparkline-canvas" class="chart" height="240" aria-label="Price sparkline" role="img" style="margin-top:0.75rem;"></canvas>
  <div class="grid two" style="margin-top:1rem;">
    <div class="card mini">
      <h3>Factor Exposures (TS)</h3>
      <canvas id="factorSeriesCanvas" class="chart" height="160" aria-label="Factor exposures timeseries" role="img"></canvas>
    </div>
    <div class="card mini">
      <h3>Options Surface (Condensed)</h3>
      <canvas id="optionsSurfaceCanvas" class="chart" height="160" aria-label="Options surface metrics" role="img"></canvas>
    </div>
  </div>
</section>

<script nonce="{{ csp_nonce }}">
// Basic skeleton removal once data sets first batch
let firstData = false;
function setField(k,v){ const el=document.querySelector(`[data-field="${k}"]`); if(el) el.textContent=v; }
function loadAccount(){
  setField('equity','$1,250,430');
  setField('cash','$250,000');
  setField('buying_power','$2,100,000');
  setField('day_pl','+$4,320');
  setField('alpha_attr','0.67');
  setField('real_vol','0.22');
  setField('iv_skew','-0.05');
  setField('drift_score','stable');
  setField('var_95','$-42,000');
  setField('exposure_conc','18%');
  setField('mdd_30d','-6.3%');
  setField('open_risk_alerts','2');
  const tbody=document.querySelector('#positions tbody');
  const rows=[['AAPL',500,178.23,179.10,'+$435'],['MSFT',300,415.10,417.55,'+$735'],['TSLA',150,245.50,244.10,'-$210']];
  tbody.innerHTML=rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');
}
async function fetchJSON(u){ const r=await fetch(u, {credentials:'include'}); if(!r.ok) throw new Error(r.status); return r.json(); }
async function loadKPIs(){
  try {
    const k=await fetchJSON('/business/api/kpis');
    const data=k.kpis||{};
    Object.entries(data).forEach(([kpi,val])=>{
      const el=document.querySelector(`[data-kpi="${kpi}"]`); if(el){ el.textContent=typeof val==='number'? val.toLocaleString(): val; }
    });
  } catch(e) { }
}
async function loadTopMovers(){
  // Best-effort from existing KPIs/coverage placeholders
  const el = document.getElementById('top-movers'); if(!el) return;
  try {
    const d = await fetchJSON('/business/api/kpis');
    const movers = (d.top_movers || [
      {symbol:'NVDA', change:2.4}, {symbol:'TSLA', change:-1.9}, {symbol:'AAPL', change:1.2}, {symbol:'AMZN', change:0.8}
    ]).slice(0,8);
    el.innerHTML = '<table class="tight"><thead><tr><th>Symbol</th><th>Î”%</th></tr></thead><tbody>'+
      movers.map(m=>`<tr><td>${m.symbol}</td><td class="${m.change>=0?'good':'bad'}">${m.change.toFixed(2)}%</td></tr>`).join('')+
      '</tbody></table>';
  } catch { el.textContent='N/A'; }
}
function colorFor(v){
  // Map -1..1 -> red..green
  const x = Math.max(-1, Math.min(1, Number(v||0)));
  const g = Math.round((x+1)/2*255), r = 255-g; return `rgb(${r},${g},96)`;
}
async function loadFactorHeatmap(){
  const el = document.getElementById('factor-heatmap'); if(!el) return;
  try{
    const list = await fetchJSON('/business/api/companies');
    const syms = (list.companies||['AAPL','MSFT','NVDA','AMZN','TSLA']).slice(0,12);
    const out = [];
    for(const s of syms){
      try { const f = await fetchJSON(`/business/api/company/${s}/factor-exposures`); const m = f.exposures||{}; const k = Object.keys(m)[0]; out.push({s, k, v: m[k]}); }
      catch { out.push({s, k:'', v:0}); }
    }
    el.innerHTML = out.map(o=>`<div class="heat" style="background:${colorFor(o.v)}20">
      <div class="sym">${o.s}</div><div class="sub">${o.k||'factor'}: ${o.v?.toFixed?o.v.toFixed(2):'â€”'}</div></div>`).join('');
  } catch { el.textContent='N/A'; }
}
async function bindIntelligence(){
  const btn = document.getElementById('intel-run'); const input = document.getElementById('intel-symbol'); const out = document.getElementById('intel-output');
  if(!btn||!input||!out) return;
  btn.addEventListener('click', async ()=>{
    const sym = (input.value||'AAPL').toUpperCase(); out.textContent='Runningâ€¦';
    try {
      // Prefer ML proxy if enabled; otherwise show company report highlights
      const body = { symbol: sym, horizon: '1d'};
      let respText = '';
      try {
        const r = await fetch('/api/v1/analysis/network', {method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        if(r.ok){ const j = await r.json(); respText = JSON.stringify(j?.summary||j, null, 2); }
      } catch(_){ }
      if(!respText){ const rep = await fetchJSON(`/business/api/company/${sym}/report`); respText = JSON.stringify(rep?.highlights||rep, null, 2); }
      out.textContent = respText || 'No insight available.';
    } catch(e){ out.textContent = 'Error: '+e.message; }
  });
}
async function loadCoverage(){
  try{
    const d=await fetchJSON('/business/api/coverage/summary');
    const ratios=d.ratios||{}; const el=document.getElementById('coverage-body');
    el.innerHTML=Object.entries(ratios).map(([k,v])=>`<div>${k}: ${(v*100).toFixed(2)}%</div>`).join('')||'No data';
    // Also fetch full health for backfill completeness gauge (cached by server, but endpoint requires admin host; if 403 ignore)
    try {
      const r = await fetch('/health/full', {credentials:'include'});
      if(r.ok){ const fh = await r.json(); const bc = fh.components?.backfill_complete; const badge=document.getElementById('backfill-complete'); if(badge){ if(bc){ badge.textContent='complete'; badge.className='badge success'; } else { badge.textContent='in-progress'; badge.className='badge warning'; } } }
    } catch(_){ /* ignore cross-host issues */ }
  }catch(e){}
}
function renderLagClasses(d){
  const order=[['equities','equities_lag_class'],['options','options_lag_class'],['news','news_lag_class'],['social','social_lag_class']];
  const parts=order.map(([label,k])=>{ const v=d[k]||'unknown'; let cls='badge'; if(v==='ok') cls+=' success'; else if(v==='warning') cls+=' warning'; else if(v==='stale') cls+=' danger'; else cls+=''; return `<span class="${cls}" style="margin-right:3px">${label}:${v}</span>`;}).join('');
  const target=document.getElementById('lag-classes'); if(target) target.innerHTML=parts;
}
async function loadIngestion(){ try{ const d=await fetchJSON('/business/api/ingestion/health'); const el=document.getElementById('ingestion-body'); el.innerHTML=`Equity Last: ${d.last_equity_bar||'â€”'}<br/>Option Last: ${d.last_option_bar||'â€”'}<br/>News Last: ${d.last_news_item||'â€”'}<br/>Social Last: ${d.last_social_item||'â€”'}`; renderLagClasses(d);}catch(e){}}
async function loadForecast(){ try{ const c=await fetchJSON('/business/api/companies'); const sym=(c.companies||['AAPL'])[0]; const f=await fetchJSON(`/business/api/company/${sym}/forecast`); const fd=f.forecasts.next_1d_return; document.getElementById('forecast-body').textContent = `${f.symbol}: ${(fd.value*100).toFixed(2)}% (conf ${(fd.confidence*100).toFixed(1)}%)`; const fb=document.getElementById('forecast-fallback'); if(fb){ if(fd.fallback){ fb.style.display='inline-block'; fb.className='badge warning'; } else { fb.style.display='none'; } } }catch(e){}}
async function loadCompanyAnalytics(){
  try {
    const c=await fetchJSON('/business/api/companies');
    const sym=(c.companies||['AAPL'])[0];
    const [fund,factors,risk,opts,factorsTS,optSurf] = await Promise.all([
      fetchJSON(`/business/api/company/${sym}/fundamentals`),
      fetchJSON(`/business/api/company/${sym}/factor-exposures`),
      fetchJSON(`/business/api/company/${sym}/risk-metrics`),
      fetchJSON(`/business/api/company/${sym}/options-summary`),
      fetchJSON(`/business/api/company/${sym}/factor-exposures/timeseries?days=90`),
      fetchJSON(`/business/api/company/${sym}/options-surface?days=60`)
    ]);
    const fbox=document.getElementById('fundamentals-box');
    if(fbox){ const fd=fund.fundamentals; fbox.innerHTML = `P/E <b>${(fd.pe??'â€”')}</b><br/>P/B <b>${(fd.pb??'â€”')}</b><br/>DivYld <b>${((fd.dividend_yield||0)*100).toFixed(2)}%</b>`; }
    const fx=document.getElementById('factors-box');
    if(fx){ const ex=factors.exposures; fx.innerHTML = Object.entries(ex).slice(0,5).map(([k,v])=>`${k}: <b>${v.toFixed(2)}</b>`).join('<br/>'); }
    const rbox=document.getElementById('risk-options-box');
    if(rbox){ const rk=risk.risk_metrics; const op=opts.options; rbox.innerHTML = `Î²60d <b>${rk.beta_60d?.toFixed(2)}</b><br/>Ïƒ20d <b>${(rk.realized_vol_20d*100).toFixed(1)}%</b><br/>Sharpe60 <b>${rk.sharpe_60d.toFixed(2)}</b><br/>IVatm <b>${(op.iv_atm*100).toFixed(1)}%</b>`; }
    // Company report panel injection (create if not present)
    let reportPanel=document.getElementById('company-report-panel');
    if(!reportPanel){
      reportPanel=document.createElement('div');
      reportPanel.id='company-report-panel';
      reportPanel.className='panel';
      reportPanel.innerHTML='<h2>Company Report</h2><pre id="company-report-json" style="font-size:0.6rem;overflow:auto;max-height:220px;">Loadingâ€¦</pre>';
      document.querySelector('body main')?.appendChild(reportPanel);
    }
    // Render factor timeseries (simple spark overlays per factor limited to first 3 factors)
    try {
      const canvas=document.getElementById('factorSeriesCanvas');
      if(canvas && factorsTS.factors){
        const ctx=canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const keys=Object.keys(factorsTS.factors).slice(0,3);
        const colors=['#3b82f6','#10b981','#f59e0b'];
        keys.forEach((k,idx)=>{
          const series=factorsTS.factors[k];
          if(!Array.isArray(series)||!series.length) return;
          const vals=series.map(p=>p.value);
          const min=Math.min(...vals), max=Math.max(...vals);
            ctx.beginPath();
            series.forEach((p,i)=>{
              const x=i/(series.length-1)*canvas.width;
              const y=canvas.height - ((p.value - min)/(max-min||1))*canvas.height;
              if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.strokeStyle=colors[idx%colors.length];
            ctx.lineWidth=1.2; ctx.stroke();
            ctx.fillStyle=colors[idx%colors.length];
            ctx.fillText(k, 4, 12+idx*12);
        });
      }
    } catch(e){}
    // Render options surface (plot iv_atm and risk_reversal_25d)
    try {
      const canvas=document.getElementById('optionsSurfaceCanvas');
      if(canvas && optSurf.surface){
        const ctx=canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const s=optSurf.surface;
        const ivVals=s.map(p=>p.iv_atm).filter(v=>typeof v==='number');
        const rrVals=s.map(p=>p.risk_reversal_25d).filter(v=>typeof v==='number');
        if(ivVals.length){
          const min=Math.min(...ivVals), max=Math.max(...ivVals);
          ctx.beginPath();
          s.forEach((p,i)=>{ if(typeof p.iv_atm!=='number') return; const x=i/(s.length-1)*canvas.width; const y=canvas.height - ((p.iv_atm-min)/(max-min||1))*canvas.height; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
          ctx.strokeStyle='#6366f1'; ctx.lineWidth=1.3; ctx.stroke(); ctx.fillStyle='#6366f1'; ctx.fillText('IVatm',4,12);
        }
        if(rrVals.length){
          const minRR=Math.min(...rrVals), maxRR=Math.max(...rrVals);
          ctx.beginPath();
          s.forEach((p,i)=>{ if(typeof p.risk_reversal_25d!=='number') return; const x=i/(s.length-1)*canvas.width; const y=canvas.height - ((p.risk_reversal_25d-minRR)/(maxRR-minRR||1))*canvas.height; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
          ctx.strokeStyle='#ef4444'; ctx.lineWidth=1; ctx.stroke(); ctx.fillStyle='#ef4444'; ctx.fillText('RR25d',42,12);
        }
      }
    } catch(e){}
    try {
      const report=await fetchJSON(`/business/api/company/${sym}/report`);
      const rp=document.getElementById('company-report-json');
      if(rp){ rp.textContent=JSON.stringify(report, null, 2); }
      // Highlights injection
      let highlights=document.getElementById('company-highlights');
      if(!highlights){
        const container=document.getElementById('company-report-panel');
        if(container){
          highlights=document.createElement('div');
          highlights.id='company-highlights';
          highlights.className='metric-grid';
          container.insertBefore(highlights, rp);
        }
      }
      if(highlights){
        highlights.innerHTML=(report.highlights||[]).map(h=>`<div class="metric-card"><h3>Highlight</h3><div class="metric-value" style="font-size:0.7rem;line-height:1.1;">${h}</div></div>`).join('');
      }
    } catch(e) { }
  } catch(e) { /* silent */ }
}
async function loadStrategyPerf(){
  // Placeholder deterministic metrics; would pull from signals/performance tables
  const html = `<div>Sharpe (30d) <b>1.42</b></div><div>Win Rate (7d) <b>56%</b></div><div>Avg Holding (hrs) <b>12.3</b></div><div>Turnover (30d) <b>3.1x</b></div>`;
  document.getElementById('strategy-metrics').innerHTML = html;
}
async function loadModelGov(){
  setField('prod_models','4');
  setField('shadow_models','2');
  setField('pending_promotions','1');
  setField('last_drift', new Date().toISOString().slice(0,19).replace('T',' '));
}
async function loadNewsFlow(){
  const el = document.getElementById('news-flow-body');
  el.innerHTML = '<div>Latest: Earnings season acceleration; volatility elevated.</div>';
}
loadAccount(); loadCoverage(); loadIngestion(); loadForecast(); loadStrategyPerf(); loadModelGov(); loadNewsFlow(); loadCompanyAnalytics(); loadKPIs(); loadTopMovers(); loadFactorHeatmap(); bindIntelligence();
setInterval(loadCoverage, 45000); setInterval(loadIngestion, 30000); setInterval(loadForecast, 60000); setInterval(loadCompanyAnalytics, 90000); setInterval(loadKPIs, 10000);
setInterval(loadTopMovers, 20000); setInterval(loadFactorHeatmap, 45000);
</script>
<script nonce="{{ csp_nonce }}" src="/static/js/business_dashboard.js"></script>
<script nonce="{{ csp_nonce }}" src="/static/js/realtime_intelligence.js"></script>
{% endblock %}
