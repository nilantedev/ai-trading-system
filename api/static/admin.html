<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading System - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-healthy { color: #28a745; }
        .status-degraded { color: #ffc107; }
        .status-error { color: #dc3545; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .sidebar { min-height: 100vh; background: #f8f9fa; }
        .nav-link.active { background: #007bff !important; color: white !important; }
        .alert-critical { border-left: 4px solid #dc3545; }
        .alert-high { border-left: 4px solid #fd7e14; }
        .alert-medium { border-left: 4px solid #ffc107; }
        .alert-low { border-left: 4px solid #28a745; }
        .refresh-btn { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3">
                <h5 class="mb-4">
                    <i class="fas fa-robot"></i> AI Trading System
                </h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard" data-tab="dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#services" data-tab="services">
                            <i class="fas fa-cogs"></i> Services
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#trading" data-tab="trading">
                            <i class="fas fa-chart-line"></i> Trading
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#portfolio" data-tab="portfolio">
                            <i class="fas fa-briefcase"></i> Portfolio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#risk" data-tab="risk">
                            <i class="fas fa-shield-alt"></i> Risk Monitor
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#alerts" data-tab="alerts">
                            <i class="fas fa-exclamation-triangle"></i> Alerts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#config" data-tab="config">
                            <i class="fas fa-sliders-h"></i> Configuration
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 id="page-title">Dashboard</h2>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync" id="refresh-icon"></i> Refresh
                        </button>
                        <span class="badge bg-success ms-2" id="connection-status">Connected</span>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard-content" class="tab-content">
                    <!-- System Overview -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-heartbeat fa-2x text-success mb-2"></i>
                                    <h5 class="card-title">System Status</h5>
                                    <h3 class="text-success" id="system-status">Healthy</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-server fa-2x text-primary mb-2"></i>
                                    <h5 class="card-title">Services</h5>
                                    <h3 class="text-primary" id="services-count">8/8</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                                    <h5 class="card-title">Portfolio</h5>
                                    <h3 class="text-success" id="portfolio-value">$125,000</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                    <h5 class="card-title">Alerts</h5>
                                    <h3 class="text-warning" id="alerts-count">2</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Charts -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-line"></i> Portfolio Performance</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="portfolioChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-tachometer-alt"></i> System Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="metricsChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-history"></i> Recent Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recent-activity">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Tab -->
                <div id="services-content" class="tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> Service Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="services-table">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Tab -->
                <div id="trading-content" class="tab-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-signal"></i> Current Signals</h5>
                                </div>
                                <div class="card-body">
                                    <div id="current-signals">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-list"></i> Recent Orders</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recent-orders">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Tab -->
                <div id="portfolio-content" class="tab-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-briefcase"></i> Current Positions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="positions-table">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Allocation</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="allocationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Tab -->
                <div id="risk-content" class="tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shield-alt"></i> Risk Monitoring</h5>
                        </div>
                        <div class="card-body">
                            <div id="risk-metrics">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Tab -->
                <div id="alerts-content" class="tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-exclamation-triangle"></i> System Alerts</h5>
                        </div>
                        <div class="card-body">
                            <div id="alerts-list">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Tab -->
                <div id="config-content" class="tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-sliders-h"></i> System Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div id="config-settings">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API Configuration
        const API_BASE = window.location.origin + '/api/v1';
        const WS_BASE = window.location.origin.replace('http', 'ws') + '/ws';
        
        // Authentication token (in production, get from secure storage)
        const AUTH_TOKEN = 'demo_token_123';
        
        // Global variables
        let portfolioChart = null;
        let metricsChart = null;
        let allocationChart = null;
        let webSockets = {};
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeCharts();
            initializeWebSockets();
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });
        
        // Tab management
        function initializeTabs() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-tab');
                    showTab(targetTab);
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update page title
                    document.getElementById('page-title').textContent = 
                        this.textContent.trim();
                });
            });
        }
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected tab
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.style.display = 'block';
                
                // Load tab-specific data
                loadTabData(tabName);
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            // Portfolio Performance Chart
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // System Metrics Chart
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(metricsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['CPU Usage', 'Memory Usage', 'Available'],
                    datasets: [{
                        data: [18.7, 25.3, 56.0],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Initialize WebSocket connections
        function initializeWebSockets() {
            // Connect to system updates
            connectWebSocket('system', `${WS_BASE}/system?token=${AUTH_TOKEN}`);
            
            // Connect to alerts
            connectWebSocket('alerts', `${WS_BASE}/alerts?token=${AUTH_TOKEN}`);
        }
        
        function connectWebSocket(type, url) {
            const ws = new WebSocket(url);
            
            ws.onopen = function() {
                console.log(`Connected to ${type} WebSocket`);
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').className = 'badge bg-success ms-2';
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(type, data);
            };
            
            ws.onclose = function() {
                console.log(`${type} WebSocket disconnected`);
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').className = 'badge bg-danger ms-2';
                
                // Reconnect after 5 seconds
                setTimeout(() => connectWebSocket(type, url), 5000);
            };
            
            ws.onerror = function(error) {
                console.error(`${type} WebSocket error:`, error);
            };
            
            webSockets[type] = ws;
        }
        
        function handleWebSocketMessage(type, data) {
            if (type === 'system') {
                updateSystemMetrics(data);
            } else if (type === 'alerts') {
                updateAlerts(data);
            }
        }
        
        // Data loading functions
        async function loadDashboardData() {
            try {
                // Load system health
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthData = await healthResponse.json();
                updateSystemHealth(healthData);
                
                // Load portfolio data
                const portfolioResponse = await fetch(`${API_BASE}/portfolio`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const portfolioData = await portfolioResponse.json();
                updatePortfolioData(portfolioData);
                
                // Load recent activity
                loadRecentActivity();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'services':
                    await loadServicesData();
                    break;
                case 'trading':
                    await loadTradingData();
                    break;
                case 'portfolio':
                    await loadPortfolioDetails();
                    break;
                case 'risk':
                    await loadRiskData();
                    break;
                case 'alerts':
                    await loadAlertsData();
                    break;
                case 'config':
                    await loadConfigData();
                    break;
            }
        }
        
        async function loadServicesData() {
            try {
                const response = await fetch(`${API_BASE}/services`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                renderServicesTable(data.services);
            } catch (error) {
                console.error('Error loading services data:', error);
            }
        }
        
        async function loadTradingData() {
            try {
                // Load current signals
                const signalsResponse = await fetch(`${API_BASE}/signals`);
                const signalsData = await signalsResponse.json();
                renderCurrentSignals(signalsData.signals);
                
                // Load recent orders
                const ordersResponse = await fetch(`${API_BASE}/orders`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const ordersData = await ordersResponse.json();
                renderRecentOrders(ordersData.orders);
            } catch (error) {
                console.error('Error loading trading data:', error);
            }
        }
        
        // Update functions
        function updateSystemHealth(healthData) {
            if (healthData.health) {
                const status = healthData.health.status;
                const element = document.getElementById('system-status');
                element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                element.className = `status-${status}`;
                
                // Update services count
                const summary = healthData.health.summary;
                document.getElementById('services-count').textContent = 
                    `${summary.healthy_services}/${summary.total_services}`;
            }
        }
        
        function updatePortfolioData(portfolioData) {
            if (portfolioData.account) {
                document.getElementById('portfolio-value').textContent = 
                    '$' + portfolioData.account.portfolio_value.toLocaleString();
            }
        }
        
        function updateSystemMetrics(data) {
            if (data.type === 'system_status' && data.data) {
                // Update charts with real-time data
                if (metricsChart) {
                    // Update system metrics chart
                    metricsChart.update();
                }
            }
        }
        
        function updateAlerts(data) {
            if (data.type === 'alert') {
                // Update alerts count
                const currentCount = parseInt(document.getElementById('alerts-count').textContent);
                document.getElementById('alerts-count').textContent = currentCount + 1;
                
                // Add to alerts list if on alerts tab
                const alertsList = document.getElementById('alerts-list');
                if (alertsList && alertsList.style.display !== 'none') {
                    renderAlert(data.data);
                }
            }
        }
        
        // Render functions
        function renderServicesTable(services) {
            const container = document.getElementById('services-table');
            let html = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Uptime</th>
                            <th>CPU</th>
                            <th>Memory</th>
                            <th>Errors</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            services.forEach(service => {
                html += `
                    <tr>
                        <td>${service.name}</td>
                        <td><span class="badge bg-${service.status === 'healthy' ? 'success' : 'warning'}">${service.status}</span></td>
                        <td>${service.uptime}</td>
                        <td>${service.cpu_usage}%</td>
                        <td>${service.memory_usage} MB</td>
                        <td>${service.error_rate.toFixed(3)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderCurrentSignals(signals) {
            const container = document.getElementById('current-signals');
            let html = '';
            
            signals.forEach(signal => {
                const badgeClass = signal.signal_type === 'BUY' ? 'success' : 
                                 signal.signal_type === 'SELL' ? 'danger' : 'secondary';
                html += `
                    <div class="mb-2 p-2 border-start border-4 border-${badgeClass}">
                        <div class="d-flex justify-content-between">
                            <strong>${signal.symbol}</strong>
                            <span class="badge bg-${badgeClass}">${signal.signal_type}</span>
                        </div>
                        <small class="text-muted">
                            Confidence: ${(signal.confidence * 100).toFixed(1)}% | 
                            ${signal.strategy_name}
                        </small>
                        <div class="mt-1">
                            <small>${signal.reasoning}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">No current signals</p>';
        }
        
        function renderRecentOrders(orders) {
            const container = document.getElementById('recent-orders');
            let html = '';
            
            orders.slice(0, 5).forEach(order => {
                const statusClass = order.status === 'filled' ? 'success' : 
                                   order.status === 'cancelled' ? 'danger' : 'warning';
                html += `
                    <div class="mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between">
                            <strong>${order.symbol}</strong>
                            <span class="badge bg-${statusClass}">${order.status}</span>
                        </div>
                        <small class="text-muted">
                            ${order.side.toUpperCase()} ${order.quantity} @ ${order.order_type}
                        </small>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">No recent orders</p>';
        }
        
        function loadRecentActivity() {
            const container = document.getElementById('recent-activity');
            container.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Signal Generated: AAPL BUY</h6>
                            <small>2 minutes ago</small>
                        </div>
                        <p class="mb-1">Momentum strategy generated strong BUY signal</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Order Filled: TSLA SELL</h6>
                            <small>15 minutes ago</small>
                        </div>
                        <p class="mb-1">Market order for 50 shares filled at $245.00</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Risk Alert: High Volatility</h6>
                            <small>1 hour ago</small>
                        </div>
                        <p class="mb-1">TSLA volatility exceeded threshold</p>
                    </div>
                </div>
            `;
        }
        
        // Refresh data
        function refreshData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('refresh-btn');
            
            loadDashboardData().finally(() => {
                refreshIcon.classList.remove('refresh-btn');
            });
        }
    </script>
</body>
</html>